# don't send the nginx version number in error pages and Server header
server_tokens off;

ssl_certificate /etc/nginx/configurations/certs/server.pem;
ssl_certificate_key /etc/nginx/configurations/certs/server.key;

map $http_user_agent $is_a_bot {
    default                                 0;

    "~Onebox"                               1;

    "~W3C_Validator"                        1;
    "~baiduspider"                          1;
    "~bingbot"                              1;
    "~embedly"                              1;
    "~facebookexternalhit"                  1;
    "~linkedinbot"                          1;
    "~outbrain"                             1;
    "~pinterest"                            1;
    "~quora link preview"                   1;
    "~rogerbot"                             1;
    "~showyoubot"                           1;
    "~slackbot"                             1;
    "~twitterbot"                           1;
    "~vkShare"                              1;
}

# We can't cache based on mime type, we have to cache based on
# endpoint for purposes of delivering the appropriate content based
# on user-agent. These numbers should be increased once the site stabalizes.
map $uri $cache_control {
    default                         "private, max-age=86400";
    "~\.(?:manifest|appcache|html|js|css|json)|sw-generated.js|main.js"  "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    "~\.(?:jpg|jpeg|png|avif|webm|woff|woff2|ttf|otf)"  "public, s-maxage=31104000, max-age=31104000";
    "~/(?:localization|elements)/"  "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
}

add_header Cache-Control $cache_control;

uwsgi_cache_path /etc/nginx/cache keys_zone=SC_CACHE:30m levels=1:2 inactive=30d max_size=8g;

# Default server - return 404 for unknown hosts
server {
    listen 80 default_server;
    listen 443 ssl default_server;
    server_name _;
    return 404;
}

# Redirect all HTTP to HTTPS suttacentral.ru
server {
    listen 80;
    server_name suttacentral.ru www.suttacentral.ru suttacentral.net www.suttacentral.net localhost;
    return 301 https://suttacentral.ru$request_uri;
}

# Redirect www and .net to non-www .ru on HTTPS
server {
    listen 443 ssl;
    server_name www.suttacentral.ru suttacentral.net www.suttacentral.net;
    return 301 https://suttacentral.ru$request_uri;
}

# Main server block for suttacentral.ru
server {
    listen 443 ssl;
    server_name suttacentral.ru;

    if (-f /opt/sc/static/maintenance_on.html) {
        return 503;
    }

    include "/etc/nginx/configurations/sc.nginx.conf";

    set $serve_dir /opt/sc/static/build;

    location ~* (\.(?:manifest|appcache|html?|xml|json)|service-worker.js)$ {
      root $serve_dir;
    }

    location ~* \.(ico|css|js|gif|svg|webp|woff2|jpe?g|png|avif)$ {
        access_log off;
        root $serve_dir;
    }

    location / {
        # config to don't allow the browser to render the page inside an frame or iframe
        # and avoid clickjacking http://en.wikipedia.org/wiki/Clickjacking
        add_header X-Frame-Options SAMEORIGIN;

        # Avoid clickjacking
        add_header X-Content-Type-Options nosniff;

        # Disable content-type sniffing on some browsers
        add_header X-Frame-Options SAMEORIGIN;

        # Enable the Cross-site scripting (XSS) filter
        add_header X-XSS-Protection "1; mode=block";

        # with Content Security Policy (CSP) enabled(and a browser that supports it(http://caniuse.com/#feat=contentsecuritypolicy),
        # you can tell the browser that it can only download content from the domains you explicitly allow
        # http://www.html5rocks.com/en/tutorials/security/content-security-policy/
        # https://www.owasp.org/index.php/Content_Security_Policy
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com https://static.cloudflareinsights.com https://hcaptcha.com https://*.hcaptcha.com; img-src https://i.creativecommons.org https://licensebuttons.net 'self' data: https://legacy.suttacentral.net https://suttacentral.net https://suttacentral.ru; connect-src 'self' https://api.stripe.com https://js.stripe.com https://cloudflareinsights.com https://hcaptcha.com https://*.hcaptcha.com https://raw.githubusercontent.com/suttacentral/editions/main/last_run_date https://*.algolia.net https://*.algolianet.com https://*.algolia.io; style-src 'self' https://hcaptcha.com https://*.hcaptcha.com 'unsafe-inline'; font-src 'self'; frame-src about: https://www.google.com https://js.stripe.com https://hcaptcha.com https://*.hcaptcha.com; object-src 'none'; media-src 'self' https://ia601508.us.archive.org;";

        # config to enable HSTS(HTTP Strict Transport Security) https://developer.mozilla.org/en-US/docs/Security/HTTP_Strict_Transport_Security
        # to avoid ssl stripping https://en.wikipedia.org/wiki/SSL_stripping#SSL_stripping
        # also https://hstspreload.org/
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";

        add_header Referrer-Policy "no-referrer-when-downgrade";

        add_header Permissions-Policy "camera=(), usb=()";

        if ($is_a_bot = 1){
            rewrite /(.*) /render/https://suttacentral.ru/$1?wc-inject-shadydom=true break;
            proxy_pass http://rendertron.suttacentral.net;
        }

        alias $serve_dir;

        try_files $uri $uri/index.html /index.html;
    }
}
